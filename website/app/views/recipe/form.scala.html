@(myForm: Form[Recipe]) 

@import helper._
@import helper.twitterBootstrap._


@ingredientsGroup(field: Field, className: String = "profile") = {
   <div class="twipsies well @className">
     <a class="removeProfile btn btn-danger pull-right">Enlever</a>
     <div class="inputIngredient">
     @helper.inputText(
        field("ingredientId"), '_label -> "Ingrédient" 
        )
     </div>
     @helper.inputText(
        field("quantity"), '_label -> "Quantité" 
        ) 
   </div>
}


@main("Création de recette", navRub = views.EnumNavRub.RECIPES) {

@if(myForm.hasErrors) {
<div class="alert-message error">
 <p>
  <strong>Oops</strong> Please fix all errors
 </p>
</div>
} 

@helper.form(action = controllers.website.routes.RecipeCtrl.submit, 'id -> "recipeForm") {

<fieldset>
 <legend>Informations génerale</legend> 
   <div class="hidden_field">
     @helper.inputText(myForm("id")) 
   </div>
   @helper.inputText(
       myForm("name"), 
       '_label -> "Nom"
   ) 
   @inputText(myForm("prepTimeSec"), '_label -> "Temps de préparation")
   @inputText(myForm("cookTimeSec"), '_label -> "Temps de cuisson")
   @helper.checkbox(myForm("isPublic"), '_label -> "Publique")
   @helper.textarea(myForm("description"), '_label -> "Description")
   @helper.textarea(myForm("instructions"), '_label -> "Instructions")
   @helper.inputText(myForm("author"), '_label -> "Auteur")
</fieldset>

<fieldset>
 <legend>Ingrédients</legend>

 <div id="profiles">
      @repeat(myForm("ingredients")) { ingredient =>
          @ingredientsGroup(ingredient)
      }
      
      @**
       * Keep an hidden block that will be used as template for Javascript copy code
       **@
      @ingredientsGroup(
          myForm("ingredients[x]"),
          className = "profile_template"
      )
              
  <div class="manage">
   <a class="addProfile btn success">Ajout d'un autre ingrédient</a>
  </div>

 </div>

</fieldset>


<div class="actions">
 <input type="submit" class="btn primary" value="Enregistrer"> 
 <a href="@controllers.website.routes.RecipeCtrl.recipes" class="btn">Annuler</a>
</div>

}

<script type="text/javascript" charset="utf-8">
   function updateRemoveBtn() {
     $('.removeProfile').click (function(e) {
    	$(this).parents('.profile').remove();
    	renumber();
     })
   }

    $('.addProfile').click (function(e) {
      var template = $('.profile_template')
      template.before('<div class="twipsies well profile">'
              + template.html() + '</div>');
      renumber();
      addAutoCompletion();
      updateRemoveBtn();
    })

// -- renumber fields

    // Rename fields to have a coherent payload like:
    //
    // ingredients[0].ingredientId
    // ingredients[0].quantity
    // ingredients[1].ingredientId
    // ingredients[1].quantity
    // ...
    //
    // This is probably not the easiest way to do it. A jQuery plugin would help.
    
    var renumber = function() {
	$('.profile').each( function(i) {
	    $('input', this).each( function() {
		   $(this).attr( 'name',
			    $(this).attr('name').replace(/ingredients\[.+?\]/g, 'ingredients[' + i + ']')
		   )
		})
      })
    }
    
    var addAutoCompletion = function() {
        $('#profiles >> div.inputIngredient >* input').each(function(index, element) {
            $(this).autocomplete({
                source:  "http://localhost:9000/ingredients/startwith.json",
                minLength: 3
            });
        })
    }
    $(function() {
      addAutoCompletion();
      updateRemoveBtn();
    })
</script>
}
