@(myForm: Form[Recipe]) 

@import helper._
@import helper.twitterBootstrap._


@ingredientsGroup(field: Field, className: String = "profile") = {
   <div class="twipsies well @className">
     <a class="removeProfile btn danger pull-right">Remove this profile</a>
     @helper.inputText(
        field("ingredientId"), 'label -> "Ingrédient" 
        )
     @helper.inputText(
        field("quantity"), 'label -> "Quantité" 
        ) 
   </div>
}


@main("Créateur de recette") {

@if(myForm.hasErrors) {
<div class="alert-message error">
 <p>
  <strong>Oops</strong> Please fix all errors
 </p>
</div>
} 

@helper.form(action = controllers.website.routes.RecipeCtrl.submit, 'id -> "recipeForm") {

<fieldset>
 <legend>General informations</legend>
   <div class="hidden_field">
     @helper.inputText(myForm("id")) 
   </div>
   @helper.inputText(myForm("name"), 'label -> "Nom") 
   @helper.inputText(myForm("prepTimeSec"), 'label -> "Temps de préparation")
   @helper.inputText(myForm("cookTimeSec"), 'label -> "Temps de cuisson")
   @helper.checkbox(myForm("isPublic"), 'label -> "Publique")
   @helper.inputText(myForm("description"), 'label -> "Description")
   @helper.inputText(myForm("instructions"), 'label -> "Instructions")
 @helper.inputText(myForm("author"), 'label -> "auteur")
</fieldset>

<fieldset>
 <legend>Ingrédients</legend>

 <div id="profiles">
      @repeat(myForm("ingredients")) { ingredient =>
          @ingredientsGroup(ingredient)
      }
      
      @**
       * Keep an hidden block that will be used as template for Javascript copy code
       **@
      @ingredientsGroup(
          myForm("informations[x]"),
          className = "profile_template"
      )
              
  <div class="manage">
   <a class="addProfile btn success">Ajout d'un autre ingrédients</a>
  </div>

 </div>

</fieldset>


<div class="actions">
 <input type="submit" class="btn primary" value="Enregistrer"> <a
  href="@controllers.website.routes.RecipeCtrl.recipes" class="btn">Annuler</a>
</div>

}

<script type="text/javascript" charset="utf-8">
   $('.removeProfile').click (function(e) {
  	$(this).parents('.profile').remove();
  	renumber();
   })

    $('.addProfile').click (function(e) {
      var template = $('.profile_template')
      template.before('<div class="twipsies well profile">'
              + template.html() + '</div>')
      renumber()
    })

    // -- renumber fields

    // Rename fields to have a coherent payload like:
    //
    // informations[0].label
    // informations[0].email
    // informations[0].phones[0]
    // informations[0].phones[1]
    // ...
    //
    // This is probably not the easiest way to do it. A jQuery plugin would help.

 
    var renumber = function(phones) {
	$('.profile').each( function(i) {
      $('input', this).each( function() {
         $(this).attr( 'name',
            $(this).attr('name').replace(/informations\[.+?\]/g, 'informations[' + i + ']'))
         })
      $('.phone input', this).each(function(i) {
         $(this).attr( 'name', 
      	    $(this).attr('name').replace( /phones\[.+\]/g,'phones[' + i + ']'))
         })
      })
    }
</script>
}
